---
import type { GetStaticPaths } from 'astro';
import Layout from '../../layouts/Layout.astro';
import HamburgerMenuNative from '../../components/HamburgerMenuNative.astro';
import ShareButton from '../../components/ShareButton';
import Footer from '../../components/Footer.astro';
import { fetchInitiatives, formatDate, formatNumber, isSigningActive } from '../../lib/initiatives';
import type { Initiative } from '../../types/initiative';
import {
  ArrowLeftIcon,
  ArrowTopRightOnSquareIcon,
  CalendarIcon,
  UserGroupIcon,
  TagIcon,
  ClockIcon,
  LinkIcon,
  FlagIcon
} from '@heroicons/react/24/outline';

export const getStaticPaths: GetStaticPaths = async () => {
  const initiatives = await fetchInitiatives();

  return initiatives.map((initiative) => ({
    params: { id: initiative.id.toString() },
    props: { initiative }
  }));
};

interface Props {
  initiative: Initiative;
}

const { initiative } = Astro.props;

if (!initiative) {
  return Astro.redirect('/404');
}

// Always use the official URL with the initiative ID for signing
const officialUrl = `https://firmereferendum.giustizia.it/referendum/open/dettaglio-open/${initiative.id}`;
const title = String(initiative.titolo || 'Iniziativa');
const description = String(initiative.descrizioneBreve || initiative.descrizione || initiative.titolo || 'Descrizione non disponibile');
const fullTitle = `${title} - Referendum e Iniziative Popolari`;
const signingActive = isSigningActive(initiative);
const ogImage = `og-${initiative.id}.png`;

// Funzione per normalizzare il baseUrl
const normalizeBaseUrl = (baseUrl: string): string => {
  if (baseUrl === '/') return '';
  return baseUrl.replace(/\/$/, '');
};

const normalizedBaseUrl = normalizeBaseUrl(import.meta.env.BASE_URL || '/');

const currentUrl = (() => {
  const site = Astro.site?.toString() || '';
  const baseUrl = import.meta.env.BASE_URL || '/';

  // Rimuovi trailing slash dal site
  const cleanSite = site.replace(/\/$/, '');

  // Gestisci il base URL: se Ã¨ solo '/', non aggiungerlo
  let cleanBase = '';
  if (baseUrl !== '/') {
    cleanBase = baseUrl.startsWith('/') ? baseUrl : `/${baseUrl}`;
    cleanBase = cleanBase.endsWith('/') ? cleanBase : `${cleanBase}/`;
  } else {
    cleanBase = '/';
  }

  return `${cleanSite}${cleanBase}initiative/${initiative.id}/`;
})();
---

<Layout title={fullTitle} description={description} ogImage={ogImage} ogType="article">
  <div class="min-h-screen bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
        <a href={import.meta.env.BASE_URL} class="inline-flex items-center text-blue-600 hover:text-blue-700 font-medium">
          <ArrowLeftIcon className="w-5 h-5 mr-2" />
          Torna alle iniziative
        </a>

        <!-- Menu Hamburger -->
        <HamburgerMenuNative baseUrl={import.meta.env.BASE_URL} />
      </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-3 sm:px-4 lg:px-8 py-4 sm:py-8">
      <!-- Header -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-8 mb-6 sm:mb-8">
        <!-- Badges -->
        <div class="flex flex-wrap gap-2 sm:gap-3 mb-4 sm:mb-6">
          <a
            href={`${normalizedBaseUrl}/?categoria=${encodeURIComponent(initiative.idDecCatIniziativa?.nome || '')}`}
            class="inline-flex items-center px-2 py-1 sm:px-3 sm:py-1 rounded-full text-xs sm:text-sm font-medium bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors duration-200 cursor-pointer"
          >
            <TagIcon className="w-3 h-3 sm:w-4 sm:h-4 mr-1" />
            {initiative.idDecCatIniziativa?.nome || 'AMBIENTE'}
          </a>
          <span class={`inline-flex items-center px-2 py-1 sm:px-3 sm:py-1 rounded-full text-xs sm:text-sm font-medium ${
            initiative.idDecStatoIniziativa?.nome?.includes('RACCOLTA')
              ? 'bg-green-100 text-green-800'
              : 'bg-gray-100 text-gray-800'
          }`}>
            <ClockIcon className="w-3 h-3 sm:w-4 sm:h-4 mr-1" />
            {initiative.idDecStatoIniziativa?.nome || 'IN RACCOLTA FIRME'}
          </span>
          <span class={`inline-flex items-center px-2 py-1 sm:px-3 sm:py-1 rounded-full text-xs sm:text-sm font-medium ${
            initiative.idDecTipoIniziativa?.id === 1
              ? 'bg-red-100 text-red-800'
              : 'bg-purple-100 text-purple-800'
          }`}>
            <TagIcon className="w-3 h-3 sm:w-4 sm:h-4 mr-1" />
            {initiative.idDecTipoIniziativa?.id === 4
              ? 'Legge di iniziativa popolare'
              : initiative.idDecTipoIniziativa?.id === 1
              ? 'Referendum abrogativo'
              : 'Tipologia non specificata'}
          </span>
        </div>

        <!-- Title -->
        <h1 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4 sm:mb-6 leading-tight">
          {initiative.titolo}
        </h1>

        <!-- CTA Buttons -->
        <div class="mb-4 sm:mb-6 flex flex-row gap-3 sm:gap-4">
          {signingActive ? (
            <a
              href={officialUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="flex-1 sm:flex-none inline-flex items-center justify-center px-4 sm:px-6 py-2.5 sm:py-3 bg-blue-600 text-white text-sm sm:text-base font-semibold rounded-lg hover:bg-blue-700 transition-colors duration-200"
            >
              Sostieni
              <ArrowTopRightOnSquareIcon className="w-4 h-4 sm:w-5 sm:h-5 ml-2" />
            </a>
          ) : (
            <a
              href={officialUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="flex-1 sm:flex-none inline-flex items-center justify-center px-4 sm:px-6 py-2.5 sm:py-3 bg-gray-400 text-gray-200 text-sm sm:text-base font-semibold rounded-lg hover:bg-gray-500 transition-colors duration-200"
            >
              Raccolta terminata
              <ArrowTopRightOnSquareIcon className="w-4 h-4 sm:w-5 sm:h-5 ml-2" />
            </a>
          )}

          <!-- Tasto Condividi -->
          <div class="flex-1 sm:flex-none">
            <ShareButton
              url={currentUrl}
              title={title}
              description={description}
              client:load
            />
          </div>
        </div>


        <!-- Stats -->
        <div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6 mb-8">
          <div class="flex items-center p-3 sm:p-4 bg-gray-50 rounded-lg">
            <CalendarIcon className="w-6 h-6 sm:w-8 sm:h-8 text-gray-600 mr-2 sm:mr-4 flex-shrink-0" />
            <div class="min-w-0">
              <p class="text-xs sm:text-sm text-gray-600">Data apertura</p>
              <p class="text-sm sm:text-lg font-semibold text-gray-900 leading-tight">{formatDate(initiative.dataApertura)}</p>
            </div>
          </div>

          {initiative.dataFineRaccolta && (
            <div class="flex items-center p-3 sm:p-4 bg-orange-50 rounded-lg">
              <CalendarIcon className="w-6 h-6 sm:w-8 sm:h-8 text-orange-600 mr-2 sm:mr-4 flex-shrink-0" />
              <div class="min-w-0">
                <p class="text-xs sm:text-sm text-orange-600">Scadenza</p>
                <p class="text-sm sm:text-lg font-semibold text-orange-900 leading-tight">{formatDate(initiative.dataFineRaccolta)}</p>
              </div>
            </div>
          )}

          {initiative.sostenitori !== undefined && (
            <div class="flex items-center p-3 sm:p-4 bg-gray-50 rounded-lg">
              <UserGroupIcon className="w-6 h-6 sm:w-8 sm:h-8 text-gray-600 mr-2 sm:mr-4 flex-shrink-0" />
              <div class="min-w-0">
                <p class="text-xs sm:text-sm text-gray-600">Sostenitori</p>
                <p class="text-sm sm:text-lg font-semibold text-gray-900 leading-tight">{formatNumber(initiative.sostenitori)}</p>
              </div>
            </div>
          )}

          {initiative.quorum !== undefined && (
            <div class="flex items-center p-3 sm:p-4 bg-blue-50 rounded-lg">
              <FlagIcon className="w-6 h-6 sm:w-8 sm:h-8 text-blue-600 mr-2 sm:mr-4 flex-shrink-0" />
              <div class="min-w-0">
                <p class="text-xs sm:text-sm text-blue-600">Quorum</p>
                <p class="text-sm sm:text-lg font-semibold text-blue-900 leading-tight">{formatNumber(initiative.quorum)}</p>
              </div>
            </div>
          )}
        </div>

        <!-- Note about signatures -->
        <p class="text-sm text-gray-500 mt-4">
          <strong>Nota bene:</strong> le firme visualizzate qui si riferiscono esclusivamente alle quelle raccolte online; il quorum finale si raggiunge sommando queste a quelle tradizionali.
        </p>
      </div>

      <!-- Description -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-8 mb-6 sm:mb-8">
        <h2 class="text-lg sm:text-xl font-semibold text-gray-900 mb-3 sm:mb-4">Descrizione</h2>

        {initiative.descrizione ? (
          <div class="w-full">
            <p class="text-gray-700 leading-relaxed whitespace-pre-line">
              {initiative.descrizione}
            </p>
          </div>
        ) : initiative.descrizioneBreve ? (
          <div class="w-full">
            <p class="text-gray-700 leading-relaxed">
              {initiative.descrizioneBreve}
            </p>
          </div>
        ) : (
          <p class="text-gray-500 italic">
            Descrizione non disponibile per questa iniziativa.
          </p>
        )}
      </div>

      <!-- Links -->
      {officialUrl && (
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-8">
          <h2 class="text-lg sm:text-xl font-semibold text-gray-900 mb-3 sm:mb-4">Link utili</h2>
          <div class="space-y-3">
            <a
              href={officialUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center text-blue-600 hover:text-blue-700 font-medium"
            >
              <LinkIcon className="w-5 h-5 mr-2" />
              {initiative.sito ? 'Sito web dell\'iniziativa' : 'Pagina ufficiale su firmereferendum.giustizia.it'}
              <ArrowTopRightOnSquareIcon className="w-4 h-4 ml-1" />
            </a>
          </div>
        </div>
      )}
    </main>

    <!-- Footer -->
    <Footer />
  </div>
</Layout>
