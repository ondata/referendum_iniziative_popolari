---
import type { GetStaticPaths } from 'astro';
import Layout from '../../layouts/Layout.astro';
import HamburgerMenuNative from '../../components/HamburgerMenuNative.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import ShareButton from '../../components/ShareButton';
import Footer from '../../components/Footer.astro';
import { fetchInitiatives, formatDate, formatNumber, isSigningActive, normalizeUrl, getRelatedInitiatives } from '../../lib/initiatives';
import type { Initiative } from '../../types/initiative';
import {
  generateArticleSchema,
  generateBreadcrumbListSchema
} from '../../lib/json-ld-schemas';
import {
  ArrowLeftIcon,
  ArrowTopRightOnSquareIcon,
  CalendarIcon,
  UserGroupIcon,
  TagIcon,
  ClockIcon,
  LinkIcon,
  FlagIcon,
  SparklesIcon,
  CheckBadgeIcon
} from '@heroicons/react/24/outline';
import fs from 'node:fs';
import { marked } from 'marked';

export const getStaticPaths: GetStaticPaths = async () => {
  const initiatives = await fetchInitiatives();

  return initiatives.map((initiative) => ({
    params: { id: initiative.id.toString() },
    props: { initiative }
  }));
};

interface Props {
  initiative: Initiative;
}

const { initiative } = Astro.props;

if (!initiative) {
  return Astro.redirect('/404');
}

const timeLineRaw = fs.readFileSync('data/time_line.jsonl', 'utf8');
const timeLineData = timeLineRaw.trim().split('\n').map(line => JSON.parse(line));
const initiativeTimeLine = timeLineData.filter(d => d.id === initiative.id);
const hasTimeLineData = initiativeTimeLine.length > 0;

// Ottieni tutte le iniziative per le correlate
const allInitiatives = await fetchInitiatives();
const relatedInitiatives = getRelatedInitiatives(initiative, allInitiatives, 3);

// Leggi il contenuto del quesito se esiste
let questionContent: string | null = null;
let questionHtml: string | null = null;
const questionPath = `data/quesiti/${initiative.id}.md`;
try {
  if (fs.existsSync(questionPath)) {
    questionContent = fs.readFileSync(questionPath, 'utf8');
    // Converti il markdown in HTML usando marked con configurazione ottimizzata
    if (questionContent) {
      // Prima puliamo il contenuto markdown per ridurre le righe vuote eccessive
      const cleanedContent = questionContent
        .replace(/\n\s*\n\s*\n/g, '\n\n')  // Riduce multiple righe vuote a massimo due
        .replace(/^\s*\n+/, '')             // Rimuove righe vuote all'inizio
        .replace(/\n+\s*$/, '');            // Rimuove righe vuote alla fine

      // Configura marked per preservare i line breaks ma senza eccessi
      marked.setOptions({
        breaks: false,  // Non convertire singoli line break in <br>
        gfm: true,      // Abilita GitHub Flavored Markdown
      });
      questionHtml = await marked(cleanedContent);
    }
  }
} catch (error) {
  console.warn(`Could not read question file for initiative ${initiative.id}:`, error);
}

// Always use the official URL with the initiative ID for signing
const officialUrl = `https://firmereferendum.giustizia.it/referendum/open/dettaglio-open/${initiative.id}`;
const title = String(initiative.titoloLeggeCostituzionale || 'Iniziativa');
const description = String(initiative.descrizioneBreve || initiative.descrizione || initiative.titoloLeggeCostituzionale || 'Descrizione non disponibile');
const fullTitle = `${title} - Referendum e Iniziative Popolari`;
const signingActive = isSigningActive(initiative);
const ogImage = `og-${initiative.id}.png`;
const hasReachedQuorum = initiative.quorum !== undefined &&
                         initiative.sostenitori !== undefined &&
                         initiative.sostenitori >= initiative.quorum;
const quorumPercentage = initiative.quorum !== undefined && initiative.sostenitori !== undefined
                         ? Math.round((initiative.sostenitori / initiative.quorum) * 100)
                         : 0;

// Funzione per normalizzare il baseUrl
const normalizeBaseUrl = (baseUrl: string): string => {
  if (baseUrl === '/') return '';
  return baseUrl.replace(/\/$/, '');
};

const normalizedBaseUrl = normalizeBaseUrl(import.meta.env.BASE_URL || '/');

const currentUrl = (() => {
  const site = Astro.site?.toString() || '';
  const baseUrl = import.meta.env.BASE_URL || '/';

  // Rimuovi trailing slash dal site
  const cleanSite = site.replace(/\/$/, '');

  // Gestisci il base URL: se Ã¨ solo '/', non aggiungerlo
  let cleanBase = '';
  if (baseUrl !== '/') {
    cleanBase = baseUrl.startsWith('/') ? baseUrl : `/${baseUrl}`;
    cleanBase = cleanBase.endsWith('/') ? cleanBase : `${cleanBase}/`;
  } else {
    cleanBase = '/';
  }

  return `${cleanSite}${cleanBase}initiative/${initiative.id}/`;
})();

// Genera URL base completo per JSON-LD
const jsonLdBaseUrl = (() => {
  const site = Astro.site?.toString() || '';
  const baseUrl = import.meta.env.BASE_URL || '/';
  const cleanSite = site.replace(/\/$/, '');
  let cleanBase = '';
  if (baseUrl !== '/') {
    cleanBase = baseUrl.startsWith('/') ? baseUrl : `/${baseUrl}`;
    cleanBase = cleanBase.endsWith('/') ? cleanBase : `${cleanBase}/`;
  } else {
    cleanBase = '/';
  }
  return `${cleanSite}${cleanBase}`;
})();

// Genera JSON-LD schemas
const articleSchema = JSON.stringify(generateArticleSchema(initiative, jsonLdBaseUrl, initiative.id));
const breadcrumbSchema = JSON.stringify(generateBreadcrumbListSchema(jsonLdBaseUrl, [
  { name: 'Home', url: jsonLdBaseUrl },
  { name: initiative.titoloLeggeCostituzionale, url: `${jsonLdBaseUrl}initiative/${initiative.id}/` }
]));
---

<Layout title={fullTitle} description={description} ogImage={ogImage} ogType="article" jsonLdSchemas={[articleSchema, breadcrumbSchema]}>
  <div class="min-h-screen">
    <!-- Navigation - Brutalist -->
    <nav role="navigation" aria-label="Navigazione principale" class="bg-civic-charcoal border-b-3 border-civic-terra">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
        <a href={import.meta.env.BASE_URL} class="inline-flex items-center text-white hover:text-civic-terra font-bold uppercase text-sm tracking-wide transition-colors border-b-2 border-transparent hover:border-civic-terra pb-1">
          <ArrowLeftIcon className="w-5 h-5 mr-2" />
          Iniziative
        </a>

        <!-- Menu Hamburger -->
        <HamburgerMenuNative baseUrl={import.meta.env.BASE_URL} />
      </div>
    </nav>

    <!-- Breadcrumb -->
    <Breadcrumb items={[
      { name: 'Home', url: jsonLdBaseUrl },
      { name: initiative.titoloLeggeCostituzionale, url: currentUrl }
    ]} />

    <!-- Main Content -->
    <main id="main-content" role="main" class="max-w-4xl mx-auto px-3 sm:px-4 lg:px-8 py-4 sm:py-8">
      <!-- Header - Brutalist -->
      <div class="bg-white border-3 border-civic-border p-4 sm:p-8 mb-6 sm:mb-8 relative">
        <!-- Decorative corner -->
        <div class="absolute top-0 right-0 w-24 h-24 border-r-3 border-t-3 border-civic-terra opacity-20"></div>

        <!-- Badges - Angular -->
        <div class="flex flex-wrap gap-2 sm:gap-3 mb-4 sm:mb-6 relative z-10">
          <a
            href={`${normalizedBaseUrl}/?categoria=${encodeURIComponent(initiative.idDecCatIniziativa?.nome || '')}`}
            class="civic-badge bg-civic-charcoal text-white text-xs hover:bg-civic-terra transition-colors cursor-pointer"
          >
            <TagIcon className="w-3 h-3 sm:w-4 sm:h-4 mr-1" />
            {initiative.idDecCatIniziativa?.nome || 'AMBIENTE'}
          </a>
          <span class={`civic-badge text-xs ${
            initiative.idDecStatoIniziativa?.nome?.includes('RACCOLTA')
              ? 'bg-civic-success text-white'
              : 'bg-civic-neutral text-white'
          }`}>
            <ClockIcon className="w-3 h-3 sm:w-4 sm:h-4 mr-1" />
            {initiative.idDecStatoIniziativa?.nome || 'IN RACCOLTA FIRME'}
          </span>
          <span class={`civic-badge text-xs ${
            initiative.idDecTipoIniziativa?.id === 1
              ? 'bg-civic-terra-dark text-white'
              : 'bg-civic-terra text-white'
          }`}>
            <TagIcon className="w-3 h-3 sm:w-4 sm:h-4 mr-1" />
            {initiative.idDecTipoIniziativa?.nome || 'Tipologia non specificata'}
          </span>
        </div>

        <!-- Title - Serif -->
        <h1 class="font-serif text-xl sm:text-2xl lg:text-3xl font-bold text-civic-charcoal mb-4 sm:mb-6 leading-tight">
          {initiative.titoloLeggeCostituzionale}
        </h1>

        <!-- CTA Buttons - Angular Brutalist -->
        <div class="mb-4 sm:mb-6 flex flex-row gap-3 sm:gap-4 relative z-10">
          {signingActive ? (
            <a
              href={officialUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="flex-1 sm:flex-none inline-flex items-center justify-center px-4 sm:px-6 py-3 sm:py-4 bg-civic-terra border-3 border-civic-border text-white text-sm sm:text-base font-bold uppercase tracking-wide hover:bg-civic-terra-dark transition-all"
            >
              Sostieni
              <ArrowTopRightOnSquareIcon className="w-4 h-4 sm:w-5 sm:h-5 ml-2" />
            </a>
          ) : (
            <a
              href={officialUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="flex-1 sm:flex-none inline-flex items-center justify-center px-4 sm:px-6 py-3 sm:py-4 bg-civic-neutral border-3 border-civic-border text-white text-sm sm:text-base font-bold uppercase tracking-wide cursor-not-allowed opacity-60"
            >
              Raccolta terminata
              <ArrowTopRightOnSquareIcon className="w-4 h-4 sm:w-5 sm:h-5 ml-2" />
            </a>
          )}

          <!-- Tasto Condividi -->
          <div class="flex-1 sm:flex-none">
            <ShareButton
              url={currentUrl}
              title={title}
              description={description}
              client:load
            />
          </div>
        </div>

        <!-- Banner Quorum Raggiunto - Brutalist -->
        {hasReachedQuorum && (
          <div class="mb-6 sm:mb-8 bg-civic-success border-3 border-civic-border p-4 sm:p-6 relative z-10">
            <div class="flex items-center justify-center gap-2 sm:gap-3 text-white">
              <CheckBadgeIcon className="w-8 h-8 sm:w-10 sm:h-10 flex-shrink-0" />
              <div class="text-center">
                <h2 class="font-serif text-xl sm:text-2xl font-bold mb-1">QUORUM RAGGIUNTO!</h2>
                <p class="text-sm sm:text-base civic-number">{quorumPercentage}% delle firme necessarie</p>
              </div>
              <CheckBadgeIcon className="w-8 h-8 sm:w-10 sm:h-10 flex-shrink-0" />
            </div>
          </div>
        )}

        <!-- Stats - Brutalist Grid -->
        <div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-8">
          <div class="border-2 border-civic-border p-3 sm:p-4 bg-white relative z-10">
            <CalendarIcon className="w-5 h-5 text-civic-terra mb-2" />
            <p class="text-xs uppercase tracking-wide text-civic-neutral font-bold mb-1">Apertura</p>
            <p class="text-sm sm:text-base font-bold text-civic-charcoal civic-number">{formatDate(initiative.dataApertura)}</p>
          </div>

          {initiative.dataFineRaccolta && (
            <div class="border-2 border-civic-terra p-3 sm:p-4 bg-civic-terra-light relative z-10">
              <CalendarIcon className="w-5 h-5 text-civic-terra-dark mb-2" />
              <p class="text-xs uppercase tracking-wide text-civic-terra-dark font-bold mb-1">Scadenza</p>
              <p class="text-sm sm:text-base font-bold text-civic-charcoal civic-number">{formatDate(initiative.dataFineRaccolta)}</p>
            </div>
          )}

          {initiative.sostenitori !== undefined && (
            <div class={`border-2 p-3 sm:p-4 relative z-10 ${
              hasReachedQuorum
                ? 'border-civic-success bg-civic-success/10'
                : 'border-civic-border bg-white'
            }`}>
              <UserGroupIcon className={`w-5 h-5 mb-2 ${hasReachedQuorum ? 'text-civic-success' : 'text-civic-terra'}`} />
              <p class={`text-xs uppercase tracking-wide font-bold mb-1 ${hasReachedQuorum ? 'text-civic-success' : 'text-civic-neutral'}`}>Sostenitori</p>
              <p class={`text-sm sm:text-base font-bold civic-number ${hasReachedQuorum ? 'text-civic-success' : 'text-civic-charcoal'}`}>{formatNumber(initiative.sostenitori)}</p>
            </div>
          )}

          {initiative.quorum !== undefined && (
            <div class={`border-2 p-3 sm:p-4 relative z-10 ${
              hasReachedQuorum
                ? 'border-civic-success bg-civic-success/10'
                : 'border-civic-border bg-white'
            }`}>
              {hasReachedQuorum ? (
                <CheckBadgeIcon className="w-5 h-5 text-civic-success mb-2" />
              ) : (
                <FlagIcon className="w-5 h-5 text-civic-terra mb-2" />
              )}
              <p class={`text-xs uppercase tracking-wide font-bold mb-1 ${hasReachedQuorum ? 'text-civic-success' : 'text-civic-neutral'}`}>Quorum</p>
              <p class={`text-sm sm:text-base font-bold civic-number ${hasReachedQuorum ? 'text-civic-success' : 'text-civic-charcoal'}`}>{formatNumber(initiative.quorum)}</p>
            </div>
          )}
        </div>

        <!-- Progress Bar del Quorum - Brutalist -->
        {initiative.quorum !== undefined && initiative.sostenitori !== undefined && (
          <div class="mb-6 relative z-10">
            <div class="flex justify-between items-center mb-3">
              <span class={`text-sm font-bold uppercase tracking-wide ${hasReachedQuorum ? 'text-civic-success' : 'text-civic-charcoal'}`}>
                Progresso
              </span>
              <span class={`text-lg font-bold civic-number ${hasReachedQuorum ? 'text-civic-success' : 'text-civic-terra'}`}>
                {quorumPercentage}%
              </span>
            </div>
            <div class="w-full bg-civic-stone border-2 border-civic-border h-5">
              <div
                class={`h-full transition-all duration-500 ${
                  hasReachedQuorum
                    ? 'bg-civic-success'
                    : 'bg-civic-terra'
                }`}
                style={`width: ${Math.min(quorumPercentage, 100)}%`}
              ></div>
            </div>
            {hasReachedQuorum && (
              <p class="text-xs sm:text-sm text-civic-success mt-2 font-bold flex items-center gap-1">
                <CheckBadgeIcon className="w-4 h-4" />
                Superato di {formatNumber(initiative.sostenitori - initiative.quorum)} firme
              </p>
            )}
          </div>
        )}

        <!-- Note about signatures -->
        <p class="text-sm text-civic-neutral mt-4 border-l-3 border-civic-terra pl-4">
          <strong class="text-civic-charcoal">Nota bene:</strong> le firme visualizzate qui si riferiscono esclusivamente a quelle raccolte online; il quorum finale si raggiunge sommando queste a quelle tradizionali. Qui sono <strong class="text-civic-charcoal">aggiornate una volta al giorno</strong>.
        </p>
      </div>

      <!-- Description - Brutalist -->
      <div class="bg-white border-3 border-civic-border p-4 sm:p-8 mb-6 sm:mb-8">
        <h2 class="font-serif text-xl sm:text-2xl font-bold text-civic-charcoal mb-4 flex items-center">
          Descrizione
          <div class="ml-4 h-0.5 flex-1 bg-gradient-to-r from-civic-terra to-transparent"></div>
        </h2>

        {initiative.descrizione ? (
          <div class="w-full">
            <p class="text-civic-charcoal leading-relaxed whitespace-pre-line">
              {initiative.descrizione}
            </p>
          </div>
        ) : initiative.descrizioneBreve ? (
          <div class="w-full">
            <p class="text-civic-charcoal leading-relaxed">
              {initiative.descrizioneBreve}
            </p>
          </div>
        ) : (
          <p class="text-civic-neutral italic">
            Descrizione non disponibile per questa iniziativa.
          </p>
        )}
      </div>

      {hasTimeLineData && (
        <div class="bg-white border-3 border-civic-border p-4 sm:p-8 mb-6 sm:mb-8">
          <h2 class="font-serif text-xl sm:text-2xl font-bold text-civic-charcoal mb-4 flex items-center">
            Timeline sostenitori
            <div class="ml-4 h-0.5 flex-1 bg-gradient-to-r from-civic-terra to-transparent"></div>
          </h2>
          <div id="chart" class="w-full overflow-x-auto"></div>
          <script type="module" define:vars={{ timelineData: initiativeTimeLine }}>            import * as Plot from "https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6/+esm";

            const fmtIt = new Intl.NumberFormat("it-IT").format;
            const fmtDateTooltip = d => d.toLocaleDateString("it-IT", {
              day: "numeric",
              month: "long",
              year: "numeric"
            });

            let lastTick = null;
            const customTickFormat = (d) => {
              if (!(d instanceof Date) || isNaN(d)) {
                return "";
              }
              const currentTick = d.toLocaleDateString("it-IT", { day: "2-digit", month: "short", year: "2-digit" });
              if (currentTick === lastTick) {
                return "";
              }
              lastTick = currentTick;
              return currentTick;
            };

            function draw() {
              const data = timelineData
                .map(d => ({ ...d, data: new Date(d.data) }))
                .sort((a, b) => a.data - b.data);

              if (data.length === 0) return;

              const container = document.getElementById("chart");
              if (!container) return;

              const { width } = container.getBoundingClientRect();
              lastTick = null;

              const chart = Plot.plot({
                width,
                marginLeft: 60,
                marginBottom: 70,
                x: {
                  type: "utc",
                  label: "Data",
                  tickFormat: customTickFormat,
                  insetLeft: 20,
                  tickRotate: 45
                },
                y: {
                  label: "Sostenitori",
                  tickFormat: fmtIt,
                  ticks: 5,
                  zero: true,
                  grid: true
                },
                marks: [
                  Plot.line(data, { x: "data", y: "sostenitori", stroke: "#1f77b4", strokeWidth: 2 }),
                  Plot.ruleX(data, Plot.pointerX({ x: "data", y: "sostenitori", stroke: "rgba(0,0,0,0.2)" })),
                  Plot.dot(data, Plot.pointerX({ x: "data", y: "sostenitori", stroke: "#1f77b4", fill: "white", r: 3, strokeWidth: 1.5 })),
                  Plot.text(data, Plot.pointerX({
                    px: "data",
                    py: "sostenitori",
                    dy: -15,
                    dx: 5,
                    text: (d) => `Data: ${fmtDateTooltip(d.data)}
Sostenitori: ${fmtIt(d.sostenitori)}`,
                    textAlign: "left",
                    lineAnchor: "bottom",
                    fill: "#333",
                    stroke: "white",
                    strokeWidth: 5
                  }))
                ]
              });

              container.innerHTML = "";
              container.append(chart);
            }

            const chartContainer = document.getElementById("chart");
            if (chartContainer) {
              draw();
              new ResizeObserver(draw).observe(chartContainer);
            }
          </script>
        </div>
      )}

      <!-- Iniziative Correlate - Brutalist -->
      {relatedInitiatives.length > 0 && (
        <div class="bg-white border-3 border-civic-border p-4 sm:p-8 mb-6 sm:mb-8">
          <h2 class="font-serif text-xl sm:text-2xl font-bold text-civic-charcoal mb-4 flex items-center">
            Iniziative correlate
            <div class="ml-4 h-0.5 flex-1 bg-gradient-to-r from-civic-terra to-transparent"></div>
          </h2>
          <p class="text-sm text-civic-neutral mb-6 border-l-3 border-civic-terra pl-4">
            Altre iniziative della categoria "<strong class="text-civic-charcoal">{initiative.idDecCatIniziativa?.nome}</strong>" con raccolta firme attiva che potrebbero interessarti:
          </p>
          <ul class="space-y-2">
            {relatedInitiatives.map((relatedInitiative) => (
              <li class="py-1">
                <a
                  href={`${normalizedBaseUrl}/initiative/${relatedInitiative.id}/`}
                  class="text-civic-terra hover:text-civic-terra-dark font-medium border-b-2 border-transparent hover:border-civic-terra transition-all leading-relaxed"
                >
                  {relatedInitiative.titoloLeggeCostituzionale}
                </a>
              </li>
            ))}
          </ul>
        </div>
      )}

      <!-- Question/Quesito - Brutalist -->
      {questionHtml && (
        <div class="bg-civic-stone border-3 border-civic-border border-l-6 border-l-civic-terra p-4 sm:p-8 mb-6 sm:mb-8">
          <h2 class="font-serif text-xl sm:text-2xl font-bold text-civic-charcoal mb-4 flex items-center">
            Quesito
            <div class="ml-4 h-0.5 flex-1 bg-gradient-to-r from-civic-terra to-transparent"></div>
          </h2>
          <div class="w-full">
            <div class="text-gray-800 leading-relaxed font-serif text-sm sm:text-base prose prose-sm max-w-none
                        prose-p:text-gray-800 prose-p:mb-3 prose-p:leading-relaxed
                        prose-h1:text-lg prose-h1:font-bold prose-h1:mb-3 prose-h1:mt-6 prose-h1:text-gray-900
                        prose-h2:text-base prose-h2:font-semibold prose-h2:mb-2 prose-h2:mt-4 prose-h2:text-gray-900
                        prose-h3:text-sm prose-h3:font-medium prose-h3:mb-2 prose-h3:mt-3 prose-h3:text-gray-800
                        prose-ul:pl-6 prose-li:mb-1 prose-li:leading-relaxed
                        prose-ol:pl-6 prose-ol:mb-3
                        prose-strong:text-gray-900 prose-strong:font-semibold
                        prose-em:italic prose-em:text-gray-700
                        [&>*:first-child]:mt-0 [&>*:last-child]:mb-0
                        [&_p+p]:mt-3 [&_h1+p]:mt-2 [&_h2+p]:mt-2 [&_h3+p]:mt-1"
                 set:html={questionHtml}></div>
          </div>
        </div>
      )}

      <!-- Links - Brutalist -->
      <div class="bg-white border-3 border-civic-border p-4 sm:p-8">
        <h2 class="font-serif text-xl sm:text-2xl font-bold text-civic-charcoal mb-4 flex items-center">
          Link utili
          <div class="ml-4 h-0.5 flex-1 bg-gradient-to-r from-civic-terra to-transparent"></div>
        </h2>
        <div class="space-y-3">
          {normalizeUrl(initiative.sito) && (
            <a
              href={normalizeUrl(initiative.sito)}
              target="_blank"
              rel="noopener noreferrer"
              class="flex items-center gap-3 text-civic-terra hover:text-civic-terra-dark font-bold py-3 px-4 border-2 border-civic-border hover:border-civic-terra transition-colors group bg-civic-stone hover:bg-white"
            >
              <LinkIcon className="w-5 h-5 flex-shrink-0" />
              <span class="flex-1">Sito web dell'iniziativa</span>
              <ArrowTopRightOnSquareIcon className="w-4 h-4" />
            </a>
          )}
          <a
            href={officialUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="flex items-center gap-3 text-civic-terra hover:text-civic-terra-dark font-bold py-3 px-4 border-2 border-civic-border hover:border-civic-terra transition-colors group bg-civic-stone hover:bg-white"
          >
            <LinkIcon className="w-5 h-5 flex-shrink-0" />
            <span class="flex-1">Pagina ufficiale su firmereferendum.giustizia.it</span>
            <ArrowTopRightOnSquareIcon className="w-4 h-4" />
          </a>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <Footer role="contentinfo" />
  </div>
</Layout>
