# Referendum Astro - AI Coding Agent Instructions

This is an **Astro + React + TypeScript** static site for displaying Italian referendum and popular initiative data from the Ministry of Justice API.

## Architecture Overview

**Data Flow**: External API → JSON files → Astro static generation → GitHub Pages deployment
- **Primary data source**: `https://firmereferendum.giustizia.it/referendum/api-portal/iniziativa/public`
- **Fallback chain**: API → local `data/source.json` → sample data in `src/data/`
- **Build-time data processing**: Data is fetched and converted during CI/CD, not at runtime

## Key Components & Patterns

### Data Management (`src/lib/initiatives.ts`)
- **Resilient data fetching**: Always implements 3-level fallback (API → local → sample)
- **Data transformation**: API returns `{content: Initiative[]}`, fallback expects direct arrays
- **Type safety**: All data conforms to `Initiative` interface in `src/types/initiative.ts`

### Hybrid Architecture (Astro + React)
- **Static pages**: `.astro` files for layout and SSG content
- **Interactive components**: `.tsx` files for client-side features (search, filters, pagination)
- **Islands architecture**: React components are "islands" of interactivity in static pages

### Base Path Handling (`src/lib/paths.ts`)
- **Dual deployment**: localhost:4321 (dev) vs GitHub Pages subdirectory (prod)
- **Environment-aware**: `astro.config.mjs` sets base path via `NODE_ENV`
- **Critical pattern**: Always use `createPath()` and `normalizeBaseUrl()` for internal links

## Essential Workflows

### Local Development
```bash
npm run dev                    # Start dev server
npm run generate-og-images     # Generate OpenGraph images
npm run build                  # Build for production (includes OG generation)
```

### Data Processing Pipeline
- **Automated**: GitHub Actions runs `scripts/download_data.sh` 6x daily
- **Tools required**: `jq`, `miller` for JSON → JSONL conversion and flattening
- **Output**: `data/source.json`, `data/source.jsonl`, timeline files
- **Manual trigger**: Available via GitHub Actions UI

### Content Structure
- **Individual referendum data**: `data/quesiti/[id].{json,md,txt}` (generated by Python script)
- **Markdown conversion**: `scripts/json2markdown.py` handles styled text with BOLD/ITALIC
- **OpenGraph images**: Auto-generated per initiative in `public/og-images/`

## Critical Patterns

### React Component Props
- **BaseUrl awareness**: All interactive components accept `baseUrl` prop for GitHub Pages compatibility
- **URL state management**: Filters and pagination sync with URL search params
- **Hydration patterns**: Components handle SSR → client transition gracefully

### Data Display Components
- **Card view**: `HomePage.tsx` with pagination (12 items/page)
- **Table view**: `TableView.tsx` with sortable columns
- **Detail pages**: Dynamic routes in `src/pages/initiative/[id].astro`

### Build Integration
- **Pre-build step**: `npm run generate-og-images` must run before `astro build`
- **Static optimization**: All external data fetched at build time, not runtime
- **GitHub Pages deployment**: Fully automated via `.github/workflows/deploy.yml`

## Configuration Gotchas

- **Astro config**: `base` path changes between dev and prod - affects all routing
- **TypeScript**: Strict mode enabled, all API responses must match `Initiative` interface
- **Tailwind**: Extended with typography plugin for rendered markdown content
- **GitHub Actions**: Uses `[skip ci]` in commits to prevent infinite build loops

## When Modifying

- **Adding new pages**: Follow Astro file-based routing in `src/pages/`
- **API integration**: Always implement fallback chain pattern from `initiatives.ts`
- **Styling**: Use Tailwind classes, check responsive breakpoints for mobile
- **Data processing**: Test scripts locally before deploying - CI runs in Ubuntu environment
